<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>pebble_manual (finger rotation control)</title>
<style>

  html, body { height: 100%; }

  body {

    margin: 0;

    background: #f6f5f2;

    display: grid;

    place-items: center;

    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;

  }

  .stage {

    width: min(84vw, 960px);

    aspect-ratio: 4 / 3;

  }

  svg {

    width: 100%;

    height: 100%;

    display: block;

    touch-action: none; /* ←指ドラッグでスクロールしないように */

  }

  /* ===== 黒い線（外殻・内殻・放射ライン） ===== */

  .outline {

    fill: none;

    stroke: #111;

    stroke-width: 28px;

    stroke-linejoin: round;

    stroke-linecap: round;

  }

  .divider {

    fill: none;

    stroke: #111;

    stroke-width: 28px;

    stroke-linecap: round;

  }

  /* ===== 白い流れる点線（血流） ===== */

  .dotted,

  .divider-dotted {

    fill: none;

    stroke: #fff;

    stroke-linecap: butt;

    stroke-width: 10px;

    stroke-dasharray: 32px 28px;

    animation: flowOneWay 2.8s linear infinite;

  }

  @keyframes flowOneWay {

    0%   { stroke-dashoffset: 0px; }

    100% { stroke-dashoffset: -60px; } /* 32 + 28 */

  }

  /* ===== 手で回す対象：内側の五角形グループ ===== */

  .inner-rot {

    /* 回転の基準点をグループ自身の中心にする指定。

       Safari(iOS)とFirefoxの両方で安定させるための組み合わせ。 */

    transform-box: fill-box;

    transform-origin: center;

    /* ここでは自動アニメーションは付けない（JSで回す） */

    cursor: grab;

  }

  .inner-rot.dragging {

    cursor: grabbing;

  }

  /* 画面右下にガイドテキスト */

  .hud {

    position: fixed;

    right: 0.75rem;

    bottom: 0.75rem;

    background: rgba(0,0,0,0.65);

    color: #fff;

    font-size: 12px;

    line-height: 1.4;

    font-family: ui-monospace, SFMono-Regular, Consolas, "Liberation Mono", monospace;

    border-radius: 8px;

    padding: 0.5rem 0.6rem;

    min-width: 8rem;

    pointer-events: none;

    user-select: none;

  }

  .hud .val {

    color: #b2ff9b;

    font-variant-numeric: tabular-nums;

  }
</style>
</head>
<body>
<div class="stage">
<svg viewBox="0 0 1200 900"

       xmlns="http://www.w3.org/2000/svg"

       aria-label="interactive pebble with manual rotation">
<!-- 外側の七角形：黒い外郭と白い血流 -->
<path class="outline"

          d="M 100,450 260,240 630,210 980,360 920,700 540,740 220,640 Z" />
<path class="dotted"

          d="M 100,450 260,240 630,210 980,360 920,700 540,740 220,640 Z" />
<!-- 回転させたい内側の五角形：黒い輪郭＋白い血流。

         まとめて <g class="inner-rot"> に入れる -->
<g class="inner-rot" id="rotTarget">
<path class="outline"

            d="M 420,470 520,340 700,370 750,520 600,590 Z" />
<path class="dotted"

            d="M 420,470 520,340 700,370 750,520 600,590 Z" />
</g>
<!-- 外郭と内郭を結ぶ放射状ライン（基準フレーム側に固定） -->
<path class="divider" d="M 420,470 L 100,450" />
<path class="divider" d="M 520,340 L 260,240" />
<path class="divider" d="M 700,370 L 630,210" />
<path class="divider" d="M 750,520 L 980,360" />
<path class="divider" d="M 600,590 L 920,700" />
<path class="divider-dotted" d="M 420,470 L 100,450" />
<path class="divider-dotted" d="M 520,340 L 260,240" />
<path class="divider-dotted" d="M 700,370 L 630,210" />
<path class="divider-dotted" d="M 750,520 L 980,360" />
<path class="divider-dotted" d="M 600,590 L 920,700" />
</svg>
</div>
<!-- いまの角度を確認する簡易HUD（デバッグ用） -->
<div class="hud">

  angle
<div class="val" id="angleVal">0.0°</div>
</div>
<script>

(function() {

  const rotTarget = document.getElementById('rotTarget');

  const angleVal  = document.getElementById('angleVal');

  // 状態

  let dragging = false;

  let lastAngleDeg = 0; // 累積回転角

  let startPointerAngleDeg = 0;

  let baseAngleDeg = 0;

  let center = { x: 0, y: 0 };

  // 内側五角形の「中心」をSVG座標系から計算する関数

  function updateCenter() {

    // getBBox() はSVG要素のバウンディングボックスを返す

    const box = rotTarget.getBBox();

    center.x = box.x + box.width / 2;

    center.y = box.y + box.height / 2;

  }

  // 与えたスクリーン座標(clientX, clientY)をSVGローカル座標に変換する

  // Firefox / Safari 両対応のためSVG座標変換をちゃんとやる

  function clientToSvgCoords(svgEl, clientX, clientY) {

    const pt = svgEl.createSVGPoint();

    pt.x = clientX;

    pt.y = clientY;

    const globalToLocal = pt.matrixTransform(svgEl.getScreenCTM().inverse());

    return { x: globalToLocal.x, y: globalToLocal.y };

  }

  // 2点の角度を返す（度数）

  function angleDegFromCenter(px, py) {

    const dx = px - center.x;

    const dy = py - center.y;

    const rad = Math.atan2(dy, dx); // -PI..PI

    return rad * 180 / Math.PI;

  }

  // 描画を更新

  function applyRotation() {

    rotTarget.style.transform = `rotate(${lastAngleDeg}deg)`;

    angleVal.textContent = lastAngleDeg.toFixed(1) + '°';

  }

  // pointerdown：ドラッグ開始

  function onPointerDown(e) {

    // ドラッグを開始した瞬間の基準値を記録

    dragging = true;

    rotTarget.classList.add('dragging');

    const svgEl = rotTarget.ownerSVGElement;

    updateCenter(); // 中心を更新

    // ポインタ位置→SVGローカル座標

    const p = clientToSvgCoords(svgEl, e.clientX, e.clientY);

    // その位置が今、中心から見てどの角度か

    startPointerAngleDeg = angleDegFromCenter(p.x, p.y);

    baseAngleDeg = lastAngleDeg;

    // マルチタッチでも1本目だけ拾えばいいのでpreventDefaultしとく

    e.preventDefault();

  }

  // pointermove：ドラッグ中なら回転を更新

  function onPointerMove(e) {

    if (!dragging) return;

    const svgEl = rotTarget.ownerSVGElement;

    const p = clientToSvgCoords(svgEl, e.clientX, e.clientY);

    const currentPointerAngleDeg = angleDegFromCenter(p.x, p.y);

    // 今の指の角度が開始角度からどれだけずれたか

    const delta = currentPointerAngleDeg - startPointerAngleDeg;

    // 累積角度 = 開始時点の角度 + 今回の差分

    lastAngleDeg = baseAngleDeg + delta;

    applyRotation();

    e.preventDefault();

  }

  // pointerup / pointercancel：ドラッグ終了

  function endDrag() {

    if (!dragging) return;

    dragging = false;

    rotTarget.classList.remove('dragging');

  }

  // イベント登録（document全体に付けることで外までドラッグしても追従する）

  document.addEventListener('pointerdown', onPointerDown);

  document.addEventListener('pointermove', onPointerMove);

  document.addEventListener('pointerup', endDrag);

  document.addEventListener('pointercancel', endDrag);

  document.addEventListener('pointerleave', endDrag);

  // 初期表示

  applyRotation();

})();
</script>
</body>
</html>
SVG namespace
 
