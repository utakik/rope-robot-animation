<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>pebble_outer_follow</title>
<style>
  html, body {
    margin: 0;
    background: #f6f5f2;
    height: 100%;
    display: grid;
    place-items: center;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  .stage {
    width: min(84vw, 960px);
    aspect-ratio: 4 / 3;
  }

  svg {
    width: 100%;
    height: 100%;
    touch-action: none; /* iPadで画面がスクロールしないように */
    display: block;
  }

  .outline {
    fill: none;
    stroke: #111;
    stroke-width: 28px;
    stroke-linejoin: round;
    stroke-linecap: round;
  }

  .dotted {
    fill: none;
    stroke: #fff;
    stroke-width: 10px;
    stroke-linecap: butt;
    stroke-dasharray: 32px 28px;
  }

  .hud {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    background: rgba(0,0,0,.65);
    color: #fff;
    font-family: monospace;
    padding: .5rem .7rem;
    border-radius: 6px;
    line-height: 1.4;
    font-size: 12px;
    min-width: 8rem;
    user-select: none;
    pointer-events: none;
  }
  .row { display: flex; justify-content: space-between; }
  .key { color:#9c9c9c; padding-right:.5rem; }
  .val { color:#b2ff9b; font-variant-numeric: tabular-nums; text-align:right; }
</style>
</head>
<body>
<div class="stage">
  <svg id="pebbleSvg" viewBox="0 0 1200 900">
    <!-- 外側の七角形をグループ化して、まとめて少し回す -->
    <g id="outerGroup">
      <path class="outline"
            d="M100,450 260,240 630,210 980,360 920,700 540,740 220,640Z"/>
      <path class="dotted"
            d="M100,450 260,240 630,210 980,360 920,700 540,740 220,640Z"/>
    </g>

    <!-- 内側の五角形。こっちは大きく回る -->
    <g id="innerGroup">
      <path class="outline"
            d="M420,470 520,340 700,370 750,520 600,590Z"/>
      <path class="dotted"
            d="M420,470 520,340 700,370 750,520 600,590Z"/>
    </g>
  </svg>
</div>

<div class="hud">
  <div class="row"><div class="key">inner</div><div class="val" id="innerVal">0.0°</div></div>
  <div class="row"><div class="key">outer</div><div class="val" id="outerVal">0.0°</div></div>
</div>

<script>
(function(){
  const svg        = document.getElementById("pebbleSvg");
  const innerGroup = document.getElementById("innerGroup");
  const outerGroup = document.getElementById("outerGroup");

  const innerValEl = document.getElementById("innerVal");
  const outerValEl = document.getElementById("outerVal");

  // 状態
  let dragging = false;

  // 内側の見た目の角度（ユーザーが回す角度、±90まで）
  let innerAngle = 0;

  // 指の前フレーム角度
  let prevPointerAngle = 0;

  // 回転中心。内側と外側、同じ中心で回して良いとする
  let center = {x:0,y:0};
  let centerReady = false;

  // 「一気に+360/-360に飛ぶ」のを避けるための差分正規化
  // 179 -> -179 を -2 と扱うなど、連続性を保つ
  function angleDelta(nowDeg, prevDeg){
    let diff = nowDeg - prevDeg;
    if (diff > 180)  diff -= 360;
    if (diff < -180) diff += 360;
    return diff;
  }

  // 回転中心の計算（最初の1回だけ）
  function initCenterIfNeeded() {
    if (centerReady) return;
    const bbox = innerGroup.getBBox();
    center.x = bbox.x + bbox.width / 2;
    center.y = bbox.y + bbox.height / 2;
    centerReady = true;
  }

  // 画面座標→SVGローカル座標
  function clientToSvgXY(evt) {
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    return pt.matrixTransform(svg.getScreenCTM().inverse());
  }

  // 中心から見た指の角度[deg]
  function pointerAngleDeg(px, py) {
    const dx = px - center.x;
    const dy = py - center.y;
    return Math.atan2(dy, dx) * 180 / Math.PI;
  }

  // 見た目反映
  function applyRotation() {
    // 内側は innerAngle（±90°まで）
    innerGroup.setAttribute(
      "transform",
      `rotate(${innerAngle},${center.x},${center.y})`
    );

    // 外側は innerAngle の 1/15ぐらいしか動かさない
    // さらに安全のため ±5° でクリップする
    let outerAngle = innerAngle * (1/15); // これで大体1/10〜1/20の中間くらい
    if (outerAngle < -5) outerAngle = -5;
    if (outerAngle >  5) outerAngle =  5;

    outerGroup.setAttribute(
      "transform",
      `rotate(${outerAngle},${center.x},${center.y})`
    );

    // HUDに表示
    innerValEl.textContent = innerAngle.toFixed(1) + "°";
    outerValEl.textContent = outerAngle.toFixed(2) + "°";
  }

  function onPointerDown(e){
    initCenterIfNeeded();
    dragging = true;

    // いまの指の角度を基準として記録
    const p = clientToSvgXY(e);
    prevPointerAngle = pointerAngleDeg(p.x, p.y);

    e.preventDefault(); // iPadで画面が揺れないように
  }

  function onPointerMove(e){
    if (!dragging) return;

    const p = clientToSvgXY(e);
    const nowA = pointerAngleDeg(p.x, p.y);

    // 前フレームとの差分だけ足し込む方式
    const d = angleDelta(nowA, prevPointerAngle);
    prevPointerAngle = nowA;

    // ユーザー角度更新
    innerAngle += d;

    // ±90°に制限
    if (innerAngle < -90) innerAngle = -90;
    if (innerAngle >  90) innerAngle =  90;

    applyRotation();
    e.preventDefault();
  }

  function onPointerUp(){
    dragging = false;
  }

  svg.addEventListener("pointerdown",  onPointerDown);
  svg.addEventListener("pointermove",  onPointerMove);
  svg.addEventListener("pointerup",    onPointerUp);
  svg.addEventListener("pointercancel",onPointerUp);
  svg.addEventListener("pointerleave", onPointerUp);

  // 初期表示
  initCenterIfNeeded();
  applyRotation();
})();
</script>
</body>
</html>