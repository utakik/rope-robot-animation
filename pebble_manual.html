<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>五角形を指で回転させる（角度ジャンプ防止版）</title>
<style>
:root {
  --outer-stroke: 28;
  --inner-stroke: 10;
  --dash: 32;
  --gap: 28;
  --speed: 2.8s;
}
html, body {
  height: 100%;
  margin: 0;
  background: #f6f5f2;
  display: grid;
  place-items: center;
}
.stage { width: min(84vw, 960px); aspect-ratio: 4 / 3; }
svg { width: 100%; height: 100%; display: block; }

.outline {
  fill: none;
  stroke: #111;
  stroke-width: var(--outer-stroke);
  stroke-linejoin: round;
  stroke-linecap: round;
}
.dotted {
  fill: none;
  stroke: #fff;
  stroke-linecap: butt;
  stroke-width: var(--inner-stroke);
  stroke-dasharray: var(--dash) var(--gap);
  animation: flowOneWay var(--speed) linear infinite;
}
.divider {
  fill: none;
  stroke: #111;
  stroke-width: var(--outer-stroke);
  stroke-linecap: round;
}
.divider-dotted {
  fill: none;
  stroke: #fff;
  stroke-linecap: butt;
  stroke-width: var(--inner-stroke);
  stroke-dasharray: var(--dash) var(--gap);
  animation: flowOneWay var(--speed) linear infinite;
}
@keyframes flowOneWay {
  0% { stroke-dashoffset: 0; }
  100% { stroke-dashoffset: calc(-1 * (var(--dash) + var(--gap))); }
}
</style>
</head>
<body>
<div class="stage">
<svg viewBox="0 0 1200 900" xmlns="http://www.w3.org/2000/svg" aria-label="rotatable pentagon">
  <!-- 外側の七角形 -->
  <path id="outerPath" class="outline" d="M 100,450 260,240 630,210 980,360 920,700 540,740 220,640 Z"/>
  <path class="dotted" d="M 100,450 260,240 630,210 980,360 920,700 540,740 220,640 Z"/>

  <!-- 内側の五角形 -->
  <g id="innerGroup">
    <path id="innerPentagon" class="outline" d="M 420,470 520,340 700,370 750,520 600,590 Z"/>
    <path class="dotted" d="M 420,470 520,340 700,370 750,520 600,590 Z"/>
  </g>

  <!-- 頂点接続線 -->
  <g id="connectors">
    <path class="divider" d="M 420,470 100,450"/>
    <path class="divider" d="M 520,340 260,240"/>
    <path class="divider" d="M 700,370 630,210"/>
    <path class="divider" d="M 750,520 980,360"/>
    <path class="divider" d="M 600,590 920,700"/>
    <path class="divider-dotted" d="M 420,470 100,450"/>
    <path class="divider-dotted" d="M 520,340 260,240"/>
    <path class="divider-dotted" d="M 700,370 630,210"/>
    <path class="divider-dotted" d="M 750,520 980,360"/>
    <path class="divider-dotted" d="M 600,590 920,700"/>
  </g>
</svg>
</div>

<script>
const innerGroup = document.getElementById("innerGroup");
const svg = document.querySelector("svg");
let rotation = 0;
let startAngle = 0;
let dragStartAngle = 0;
let dragging = false;
let center = { x: 0, y: 0 };

function updateCenter() {
  const bbox = innerGroup.getBBox();
  const pt = svg.createSVGPoint();
  pt.x = bbox.x + bbox.width / 2;
  pt.y = bbox.y + bbox.height / 2;
  const screenCTM = svg.getScreenCTM();
  const c = pt.matrixTransform(screenCTM);
  center = { x: c.x, y: c.y };
}

// 角度ジャンプ防止関数
function angleDiff(a, b) {
  let diff = a - b;
  diff = ((diff + 180) % 360) - 180;
  return diff;
}

function getPointerAngle(e) {
  const touch = e.touches ? e.touches[0] : e;
  const dx = touch.clientX - center.x;
  const dy = touch.clientY - center.y;
  return Math.atan2(dy, dx) * 180 / Math.PI;
}

svg.addEventListener("pointerdown", (e) => {
  updateCenter();
  dragging = true;
  startAngle = rotation;
  dragStartAngle = getPointerAngle(e);
  svg.setPointerCapture(e.pointerId);
});

svg.addEventListener("pointermove", (e) => {
  if (!dragging) return;
  const currentAngle = getPointerAngle(e);
  const delta = angleDiff(currentAngle, dragStartAngle);
  rotation = startAngle + delta;
  // 回転を±90°に制限
  rotation = Math.max(-90, Math.min(90, rotation));
  innerGroup.setAttribute("transform", `rotate(${rotation}, ${center.x}, ${center.y})`);
});

svg.addEventListener("pointerup", (e) => {
  dragging = false;
  svg.releasePointerCapture(e.pointerId);
});

svg.addEventListener("pointerleave", () => dragging = false);
</script>
</body>
</html>